{"version":3,"file":"broccoli-tree-stabilizer.js","sourceRoot":"","sources":["../../../tools/broccoli/broccoli-tree-stabilizer.ts"],"names":[],"mappings":";AAAA,IAAO,EAAE,WAAW,IAAI,CAAC,CAAC;AAC1B,IAAI,aAAa,GAAG,OAAO,CAAC,iBAAiB,CAAC,CAAC;AAG/C;;;;;;;;;;;;;GAaG;AACH;IAKE,wBAAmB,SAAuB;QAAvB,cAAS,GAAT,SAAS,CAAc;IAAG,CAAC;IAG9C,gCAAO,GAAP;QACE,EAAE,CAAC,SAAS,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC;QAE9B,yFAAyF;QACzF,UAAU;QACV,aAAa,CAAC,IAAI,CAAC,IAAI,CAAC,SAAS,EAAE,IAAI,CAAC,UAAU,CAAC,CAAC;IACtD,CAAC;IAGD,gCAAO,GAAP,cAAW,CAAC;IACd,qBAAC;AAAD,CAAC,AAlBD,IAkBC;AAGD,uBAAsC,SAAuB;IAC3D,MAAM,CAAC,IAAI,cAAc,CAAC,SAAS,CAAC,CAAC;AACvC,CAAC;AAFD;+BAEC,CAAA","sourcesContent":["import fs = require('fs');\nlet symlinkOrCopy = require('symlink-or-copy');\n\n\n/**\n * Stabilizes the inputPath for the following plugins in the build tree.\n *\n * All broccoli plugins that inherit from `broccoli-writer` or `broccoli-filter` change their\n * outputPath during each rebuild.\n *\n * This means that all following plugins in the build tree can't rely on their inputPath being\n * immutable. This results in breakage of any plugin that is not expecting such behavior.\n *\n * For example all `DiffingBroccoliPlugin`s expect their inputPath to be stable.\n *\n * By inserting this plugin into the tree after any misbehaving plugin, we can stabilize the\n * inputPath for the following plugin in the tree and correct the surprising behavior.\n */\nclass TreeStabilizer implements BroccoliTree {\n  inputPath: string;\n  outputPath: string;\n\n\n  constructor(public inputTree: BroccoliTree) {}\n\n\n  rebuild() {\n    fs.rmdirSync(this.outputPath);\n\n    // TODO: investigate if we can use rename the directory instead to improve performance on\n    // Windows\n    symlinkOrCopy.sync(this.inputPath, this.outputPath);\n  }\n\n\n  cleanup() {}\n}\n\n\nexport default function stabilizeTree(inputTree: BroccoliTree): BroccoliTree {\n  return new TreeStabilizer(inputTree);\n}\n"]}